---
import type { MarkdownHeading } from 'astro'
import type { CollectionEntry } from 'astro:content'

// Plugin styles
import 'katex/dist/katex.min.css'

import { MediumZoom } from 'astro-pure/advanced'
import { ArticleBottom, Hero } from 'astro-pure/components/pages'
import config from 'virtual:config'
import PageLayout from '@/layouts/ContentLayout.astro'
import { verifySignedCookieValue } from '@/pages/api/verify'
import Copyright from '@/components/custom/Copyright.astro'
import TOC from '@/components/custom/TOC.astro'
import PasswordForm from '@/components/vue/PasswordForm.vue'
import { Comment, PageInfo } from '@/components/waline'

interface Props {
  post: CollectionEntry<'blog'>
  posts: CollectionEntry<'blog'>[]
  headings: MarkdownHeading[]
  remarkPluginFrontmatter: Record<string, unknown>
}

const {
  post: { id, data },
  posts,
  headings,
  remarkPluginFrontmatter
} = Astro.props

const {
  description,
  heroImage,
  publishDate,
  title,
  updatedDate,
  draft: isDraft,
  comment: enableComment
} = data

const socialImage = heroImage
  ? typeof heroImage.src === 'string'
    ? heroImage.src
    : heroImage.src.src
  : config.socialCard
const articleDate = updatedDate?.toISOString() ?? publishDate.toISOString()
const primaryColor = data.heroImage?.color ?? 'hsl(var(--primary) / var(--un-text-opacity))'

// 读取 cookie 并验证
const cookieHeader = Astro.request.headers.get('cookie')
let verified = false
if (cookieHeader) {
  const cookies = Object.fromEntries(
    cookieHeader.split(';').map((s) => {
      const [k, v] = s.trim().split('=')
      return [k, v]
    })
  )
  const result = verifySignedCookieValue(cookies[`verified-${id}`])
  if (result && result === id) verified = true
}

const password = data.password || []
const questions = password.map((p) => p.question)
if (questions.length == 0) {
  verified = true
}
---

<PageLayout
  meta={{ articleDate, description, ogImage: socialImage, title }}
  highlightColor={primaryColor}
  back='/blog'
>
  {verified && !!headings.length && <TOC {headings} slot='sidebar' />}

  <Hero {data} {remarkPluginFrontmatter} slot='header'>
    <Fragment slot='description'>
      {!isDraft && enableComment && <PageInfo comment class='mt-1' />}
    </Fragment>
  </Hero>

  {verified ? <slot /> : <PasswordForm slug={id} questions={questions} client:load />}

  <Fragment slot='bottom'>
    {/* Copyright */}
    <Copyright {data} />
    {/* Article recommend */}
    <ArticleBottom collections={posts} {id} class='mt-3 sm:mt-6' />
    { /* Comment */
    !isDraft && enableComment && <Comment class='mt-3 sm:mt-6' />}
  </Fragment>

  <slot name='bottom-sidebar' slot='bottom-sidebar' />
</PageLayout>

{config.integ.mediumZoom.enable && <MediumZoom />}
